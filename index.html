<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Prediction Dashboard</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

    <style>
      body { background: #f7f9fc; }
      .card { box-shadow: 0 6px 18px rgba(23,23,23,0.06); }
      .small-muted { font-size: .85rem; color: #6c757d; }
      #vizImage { max-width: 100%; height: auto; border-radius: 8px; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center mb-4">
        <h2 class="me-3">Stock Prediction Dashboard</h2>
        <div class="small-muted">Connects to Flask backend at <code>http://localhost:5000</code></div>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <div class="card p-3">
            <label class="form-label">Stock Symbol</label>
            <input id="symbolInput" class="form-control" placeholder="e.g. TSLA or AAPL" />

            <div class="d-grid gap-2 d-md-block mt-3">
              <button id="btnValidate" class="btn btn-outline-primary btn-sm">Validate Symbol</button>
              <button id="btnHistory" class="btn btn-outline-secondary btn-sm">Load History</button>
            </div>

            <hr />
            <label class="form-label">Train Model</label>
            <select id="modelType" class="form-select mb-2">
              <option value="rf" selected>Random Forest (rf)</option>
              <option value="linear">Linear Regression (linear)</option>
              <option value="lstm">LSTM (lstm) — optional</option>
            </select>
            <div class="input-group mb-2">
              <span class="input-group-text">Window</span>
              <input id="trainWindow" class="form-control" type="number" value="20" />
              <span class="input-group-text">Epochs (LSTM)</span>
              <input id="trainEpochs" class="form-control" type="number" value="20" />
            </div>
            <button id="btnTrain" class="btn btn-success w-100">Train</button>

            <hr />
            <label class="form-label">Predict / Visualize</label>
            <div class="input-group mb-2">
              <span class="input-group-text">Days</span>
              <input id="predictDays" type="number" class="form-control" value="30" />
              <span class="input-group-text">Window</span>
              <input id="predictWindow" type="number" class="form-control" value="20" />
            </div>
            <div class="d-grid gap-2 d-md-block">
              <button id="btnPredict" class="btn btn-primary btn-sm">Get Predictions (JSON)</button>
              <button id="btnViz" class="btn btn-outline-primary btn-sm">Show Visualization (Image)</button>
            </div>

            <hr />
            <div id="status" class="small-muted mt-2">Status: Idle</div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card p-3 mb-3">
            <h5>Chart: History + Predictions</h5>
            <canvas id="stockChart" height="180"></canvas>
          </div>

          <div class="card p-3 mb-3">
            <h5>Visualization (server-generated PNG)</h5>
            <div class="d-flex justify-content-center p-3">
              <img id="vizImage" src="" alt="Visualization will appear here" />
            </div>
          </div>

          <div class="card p-3">
            <h5>Raw JSON / Logs</h5>
            <pre id="logArea" style="height:220px; overflow:auto; background:#0f1724; color:#e6eef8; padding:12px; border-radius:6px;"></pre>
          </div>
        </div>
      </div>

      <footer class="mt-4 small-muted">Tip: start the Flask backend (app.py) on <code>http://localhost:5000</code>. If your backend runs elsewhere set the <code>API_BASE</code> variable inside the script section.</footer>
    </div>

    <script>
      // ====== Configuration ======
      const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:5000'
        : 'http://localhost:5000'; // change if backend is remote

      // ====== UI elements ======
      const symbolInput = document.getElementById('symbolInput');
      const btnValidate = document.getElementById('btnValidate');
      const btnHistory = document.getElementById('btnHistory');
      const btnTrain = document.getElementById('btnTrain');
      const btnPredict = document.getElementById('btnPredict');
      const btnViz = document.getElementById('btnViz');
      const status = document.getElementById('status');
      const logArea = document.getElementById('logArea');
      const vizImage = document.getElementById('vizImage');
      const chartCtx = document.getElementById('stockChart').getContext('2d');

      const modelTypeEl = document.getElementById('modelType');
      const trainWindowEl = document.getElementById('trainWindow');
      const trainEpochsEl = document.getElementById('trainEpochs');
      const predictDaysEl = document.getElementById('predictDays');
      const predictWindowEl = document.getElementById('predictWindow');

      function setStatus(msg) { status.textContent = 'Status: ' + msg; }
      function log(msg) { logArea.textContent = msg + '\n\n' + logArea.textContent; }

      // ====== Chart setup ======
      let stockChart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'History', data: [], borderWidth: 2, tension: 0.2, pointRadius: 0 },
            { label: 'Predicted', data: [], borderDash: [6,4], borderWidth: 2, tension: 0.2, pointRadius: 3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: false } }
        }
      });

      // ====== Helpers ======
      function apiGET(path) {
        return fetch(API_BASE + path).then(r => r.json());
      }

      function apiPOST(path, body) {
        return fetch(API_BASE + path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
          .then(r => r.json());
      }

      // ====== Actions ======
      btnValidate.addEventListener('click', async () => {
        const s = symbolInput.value.trim().toUpperCase();
        if (!s) { alert('Enter a symbol'); return; }
        setStatus('Validating ' + s + '...');
        try {
          const res = await apiGET(`/validate?symbol=${s}`);
          log(JSON.stringify(res, null, 2));
          if (res.valid) {
            setStatus('Symbol valid — ' + (res.info.shortName || res.info.longName || s));
          } else {
            setStatus('Invalid symbol or no info');
          }
        } catch (err) {
          setStatus('Validation failed');
          log(err.toString());
        }
      });

      btnHistory.addEventListener('click', async () => {
        const s = symbolInput.value.trim().toUpperCase();
        if (!s) { alert('Enter a symbol'); return; }
        setStatus('Loading history for ' + s + '...');
        try {
          const res = await apiGET(`/history?symbol=${s}`);
          if (res.error) { throw new Error(res.error); }
          // use history to update chart
          const history = res.history.map(r => ({ x: r.Date, y: Number(r.Close) }));
          stockChart.data.labels = history.map(h => h.x);
          stockChart.data.datasets[0].data = history.map(h => ({ x: h.x, y: h.y }));
          stockChart.data.datasets[1].data = []; // clear predictions
          stockChart.update();
          setStatus('History loaded (' + history.length + ' points)');
          log('Loaded history for ' + s + '\n' + JSON.stringify(res.history.slice(-5), null, 2));
        } catch (err) {
          setStatus('Failed to load history');
          log(err.toString());
        }
      });

      btnTrain.addEventListener('click', async () => {
        const s = symbolInput.value.trim().toUpperCase();
        if (!s) { alert('Enter a symbol'); return; }
        const payload = {
          symbol: s,
          model_type: modelTypeEl.value,
          start: null,
          end: null,
          window: Number(trainWindowEl.value) || 20,
          epochs: Number(trainEpochsEl.value) || 20,
          force: false
        };
        setStatus('Training ' + payload.model_type + ' for ' + s + '...');
        try {
          const res = await apiPOST('/train', payload);
          if (res.error) { throw new Error(res.error); }
          setStatus('Training finished');
          log('Train response:\n' + JSON.stringify(res, null, 2));
        } catch (err) {
          setStatus('Training failed');
          log(err.toString());
        }
      });

      btnPredict.addEventListener('click', async () => {
        const s = symbolInput.value.trim().toUpperCase();
        if (!s) { alert('Enter a symbol'); return; }
        const days = Number(predictDaysEl.value) || 30;
        const window = Number(predictWindowEl.value) || 20;
        setStatus('Fetching predictions...');
        try {
          const res = await apiGET(`/predict?symbol=${s}&model_type=${modelTypeEl.value}&days=${days}&window=${window}`);
          if (res.error) { throw new Error(res.error); }
          // update chart: append predictions
          const history = res.last_history.map(r => ({ x: r.Date, y: Number(r.Close) }));
          const preds = res.predictions.map(p => ({ x: p.date, y: Number(p.predicted_close) }));
          stockChart.data.labels = history.map(h => h.x).concat(preds.map(p => p.x));
          stockChart.data.datasets[0].data = history.map(h => ({ x: h.x, y: h.y }));
          stockChart.data.datasets[1].data = preds;
          stockChart.update();
          setStatus('Predictions received (' + preds.length + ' days)');
          log('Predict response:\n' + JSON.stringify(res, null, 2));
        } catch (err) {
          setStatus('Prediction failed');
          log(err.toString());
        }
      });

      btnViz.addEventListener('click', () => {
        const s = symbolInput.value.trim().toUpperCase();
        if (!s) { alert('Enter a symbol'); return; }
        const days = Number(predictDaysEl.value) || 30;
        const window = Number(predictWindowEl.value) || 20;
        const model = modelTypeEl.value;
        setStatus('Fetching visualization image...');
        // show the server-generated PNG
        const url = `${API_BASE}/visualize?symbol=${s}&model_type=${model}&days=${days}&window=${window}`;
        // add a timestamp to bust cache
        vizImage.src = url + `&t=${Date.now()}`;
        vizImage.onload = () => { setStatus('Visualization loaded'); };
        vizImage.onerror = () => { setStatus('Failed to load visualization'); log('Failed to fetch image at ' + url); };
      });

      // Optionally: auto-fill a popular symbol for quick testing
      symbolInput.value = 'AAPL';
    </script>

    <!-- Bootstrap JS (optional for some components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>